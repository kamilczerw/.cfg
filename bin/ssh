#!/usr/bin/env bash

OP_SSH_KEY_ID=${OP_SSH_KEY_ID:-"kam.czerwinski@gmail.com"}

ARG=${1}

function log {
    if [[ "${ARG}" != "-q" ]]
    then
        echo ${@}
    fi
}

function op_session {
    eval $(op signin my.1password.com $OP_EMAIL $OP_SECRET_KEY)
}

function get_key {
    FIFO=$1

    GET_DOCUMENT_CMD="op get document ${OP_SSH_KEY_ID} --vault=keys"

    $GET_DOCUMENT_CMD &> ${FIFO}
    CODE=$?

    if [[ $CODE != 0 ]]; then
        case $(cat ${FIFO}) in
            *ERROR\)\ You\ are\ not\ currently\ signed\ in*) op_session
                $GET_DOCUMENT_CMD &> ${FIFO}
            ;;
            *) echo "Couldn't get ssh key! Check if your \$OP_SSH_KEY_ID is correct"
                cat ${FIFO}
                exit 1
            ;;
        esac
    fi

}

function ensure_ssh_key_added {
    if ssh-add -l | cut -d ' ' -f 3 | grep -q -E "${OP_SSH_KEY_ID}\$"
    then
        log id_rsa already added to agent 
    else
        log ssh not added
        FIFO=$(mktemp -u --suffix=.${OP_SSH_KEY_ID})
        # mkfifo -m 600 ${FIFO}
        
        trap "rm -rf ${FIFO}" EXIT
        get_key ${FIFO} 
        chmod 600 ${FIFO}
        log $(ssh-add ${FIFO} < /dev/null)
    fi
}

ensure_ssh_key_added
/usr/bin/ssh "$@"
